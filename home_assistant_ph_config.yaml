# Home Assistant Configuration –¥–ª—è ESP32 pH Sensor
# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –≤–∞—à configuration.yaml

mqtt:
  sensor:
    # ============================================
    # pH Sensor - –û—Å–Ω–æ–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ pH
    # ============================================
    - name: "pH Sensor"
      unique_id: "esp32_ph_sensor_value"
      state_topic: "sensor/ph/value"
      value_template: "{{ value_json.pH }}"
      unit_of_measurement: "pH"
      device_class: "ph"
      state_class: "measurement"
      icon: "mdi:ph"
      availability_topic: "sensor/ph/status"
      availability_template: "{{ 'online' if value_json.status == 'online' else 'offline' }}"
      json_attributes_topic: "sensor/ph/value"
      json_attributes_template: "{{ {'voltage': value_json.voltage, 'timestamp': value_json.timestamp} | tojson }}"
      
    # ============================================
    # pH Sensor - –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ
    # ============================================
    - name: "pH Sensor Voltage"
      unique_id: "esp32_ph_sensor_voltage"
      state_topic: "sensor/ph/value"
      value_template: "{{ value_json.voltage | round(3) }}"
      unit_of_measurement: "V"
      device_class: "voltage"
      state_class: "measurement"
      icon: "mdi:flash"
      availability_topic: "sensor/ph/status"
      availability_template: "{{ 'online' if value_json.status == 'online' else 'offline' }}"
      
    # ============================================
    # pH Sensor - –°—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    # ============================================
    - name: "pH Sensor Status"
      unique_id: "esp32_ph_sensor_status"
      state_topic: "sensor/ph/status"
      value_template: "{{ value_json.status }}"
      icon: "mdi:check-network"
      
    # ============================================
    # pH Sensor - IP –∞–¥—Ä–µ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    # ============================================
    - name: "pH Sensor IP"
      unique_id: "esp32_ph_sensor_ip"
      state_topic: "sensor/ph/status"
      value_template: "{{ value_json.ip }}"
      icon: "mdi:ip-network"

# ============================================
# Template Sensors (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ============================================
template:
  - sensor:
      # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è pH (–∫–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç—å/—â–µ–ª–æ—á–Ω–æ—Å—Ç—å)
      - name: "pH Classification"
        unique_id: "ph_classification"
        state: >
          {% set ph = states('sensor.ph_sensor') | float(7) %}
          {% if ph < 6.5 %}
            –ö–∏—Å–ª–∞—è
          {% elif ph > 7.5 %}
            –©–µ–ª–æ—á–Ω–∞—è
          {% else %}
            –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è
          {% endif %}
        icon: >
          {% set ph = states('sensor.ph_sensor') | float(7) %}
          {% if ph < 6.5 %}
            mdi:ph-minus
          {% elif ph > 7.5 %}
            mdi:ph-plus
          {% else %}
            mdi:ph
          {% endif %}
      
      # –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      - name: "pH Last Update"
        unique_id: "ph_last_update"
        state: >
          {{ state_attr('sensor.ph_sensor', 'timestamp') | int | timestamp_local if state_attr('sensor.ph_sensor', 'timestamp') else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}
        icon: "mdi:clock-outline"

# ============================================
# –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ============================================
automation:
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–æ–º pH
  - alias: "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–∏–∑–∫–∏–π pH"
    description: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ pH –Ω–∏–∂–µ 6.0"
    trigger:
      - platform: numeric_state
        entity_id: sensor.ph_sensor
        below: 6.0
        for:
          minutes: 5
    action:
      - service: notify.notify
        data:
          title: "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–∏–∑–∫–∏–π pH"
          message: "pH –≤–æ–¥—ã —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π: {{ states('sensor.ph_sensor') }}"
  
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ–º pH
  - alias: "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –í—ã—Å–æ–∫–∏–π pH"
    description: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ pH –≤—ã—à–µ 8.0"
    trigger:
      - platform: numeric_state
        entity_id: sensor.ph_sensor
        above: 8.0
        for:
          minutes: 5
    action:
      - service: notify.notify
        data:
          title: "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –í—ã—Å–æ–∫–∏–π pH"
          message: "pH –≤–æ–¥—ã —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π: {{ states('sensor.ph_sensor') }}"
  
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏ —Å –¥–∞—Ç—á–∏–∫–æ–º
  - alias: "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: pH –¥–∞—Ç—á–∏–∫ –æ—Ñ–ª–∞–π–Ω"
    description: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –¥–∞—Ç—á–∏–∫ —Ç–µ—Ä—è–µ—Ç —Å–≤—è–∑—å"
    trigger:
      - platform: state
        entity_id: sensor.ph_sensor_status
        to: "offline"
        for:
          minutes: 2
    action:
      - service: notify.notify
        data:
          title: "üî¥ pH –¥–∞—Ç—á–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          message: "–î–∞—Ç—á–∏–∫ pH –ø–æ—Ç–µ—Ä—è–ª —Å–≤—è–∑—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ."

# ============================================
# Lovelace UI Cards
# ============================================
# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –≤–∞—à Lovelace dashboard

# –ö–∞—Ä—Ç–æ—á–∫–∞ 1: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
type: entities
title: pH Monitoring
entities:
  - entity: sensor.ph_sensor
    name: pH Value
    icon: mdi:ph
  - entity: sensor.ph_classification
    name: Classification
  - entity: sensor.ph_sensor_voltage
    name: Sensor Voltage
  - entity: sensor.ph_sensor_status
    name: Device Status
  - entity: sensor.ph_sensor_ip
    name: Device IP
  - entity: sensor.ph_last_update
    name: Last Update

# –ö–∞—Ä—Ç–æ—á–∫–∞ 2: Gauge (—Å—Ç—Ä–µ–ª–æ—á–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)
type: gauge
entity: sensor.ph_sensor
name: pH Level
unit: pH
min: 0
max: 14
severity:
  green: 6.5
  yellow: 6.0
  red: 0
needle: true
segments:
  - from: 0
    color: '#db4437'
  - from: 6.0
    color: '#ff9800'
  - from: 6.5
    color: '#0f9d58'
  - from: 7.5
    color: '#ff9800'
  - from: 8.5
    color: '#db4437'

# –ö–∞—Ä—Ç–æ—á–∫–∞ 3: –ò—Å—Ç–æ—Ä–∏—è (–≥—Ä–∞—Ñ–∏–∫)
type: history-graph
title: pH History (24h)
entities:
  - entity: sensor.ph_sensor
hours_to_show: 24
refresh_interval: 0

# –ö–∞—Ä—Ç–æ—á–∫–∞ 4: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
type: statistics-graph
title: pH Statistics
entities:
  - sensor.ph_sensor
stat_types:
  - mean
  - min
  - max
chart_type: line
period:
  calendar:
    period: day

# –ö–∞—Ä—Ç–æ—á–∫–∞ 5: –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
type: horizontal-stack
cards:
  - type: sensor
    entity: sensor.ph_sensor
    name: Current pH
    graph: line
    detail: 1
  - type: sensor
    entity: sensor.ph_sensor_voltage
    name: Voltage
    graph: line
    detail: 2

# –ö–∞—Ä—Ç–æ—á–∫–∞ 6: –ü–æ–ª–Ω–∞—è –ø–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
type: vertical-stack
cards:
  - type: markdown
    content: |
      ## üíß pH Water Monitor
      –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ pH –≤–æ–¥—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  
  - type: gauge
    entity: sensor.ph_sensor
    name: pH Level
    min: 0
    max: 14
    severity:
      green: 6.5
      yellow: 6.0
      red: 0
  
  - type: entities
    entities:
      - entity: sensor.ph_sensor
        name: pH Value
        icon: mdi:ph
      - entity: sensor.ph_classification
        name: Classification
      - entity: sensor.ph_sensor_voltage
        name: Voltage
      - type: divider
      - entity: sensor.ph_sensor_status
        name: Status
      - entity: sensor.ph_last_update
        name: Last Update
  
  - type: history-graph
    entities:
      - entity: sensor.ph_sensor
    hours_to_show: 24
    refresh_interval: 0

# ============================================
# Recorder Configuration (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ============================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ
recorder:
  include:
    entities:
      - sensor.ph_sensor
      - sensor.ph_sensor_voltage
      - sensor.ph_sensor_status
  
  # –•—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ 90 –¥–Ω–µ–π
  purge_keep_days: 90

# ============================================
# InfluxDB Integration (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ============================================
# –î–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
influxdb:
  host: localhost
  port: 8086
  database: home_assistant
  username: !secret influxdb_username
  password: !secret influxdb_password
  include:
    entities:
      - sensor.ph_sensor
      - sensor.ph_sensor_voltage

